<!doctype html>
<html>
    <head>
        <meta charset="utf-8">
        <title>EditControl Demo</title>
        <style>
            html, body {
                overflow: hidden;
                width: 100%;
                height: 100%;
                margin: 0;
                padding: 0;
            }

            table {
                border-radius: 10px;
            }

            table, th, td {
                border: 1px solid black;
                padding: 5px;
                padding-left: 15px;
                padding-right: 15px;
                border-collapse: collapse;
            }

            #controls {
                position: absolute;
                left: 10px;
                top: 10px;
            }

            #renderCanvas {
                position: absolute;
                top: 0;
                right: 0;
                width: 100%;
                height: 100%;
                touch-action: none;
            }

            #overlay {
                visibility: hidden;
                position: absolute;
                left: 0px;
                top: 0px;
                width: 100%;
                height: 100%;
                text-align: center;
                z-index: 1000;
            }

            #overlay div {
                width: 400px;
                margin: 100px auto;
                background-color: #fff;
                border: 1px solid #000;
                padding: 15px;
                text-align: center;
            }
        </style>

        <script src="https://code.jquery.com/pep/0.4.2/pep.js"></script>

        <!-- load BabylonJS -->

        <!-- a specific version-->
        <!--<script src="lib/babylon-3.1.1-12.13.2017.js"></script>-->
        <!-- stable version -->
        <!--<script src="https://cdn.babylonjs.com/babylon.js"></script>-->
        <!-- preview version-->
        <script src="https://preview.babylonjs.com/babylon.js"></script>

        <!-- load EditControl -->

        <!-- stable or preview ? -->
        <!-- load based on url search parm, if "?stable" load stable else preview -->
        <script>
            window.onload = function(){
                var search = window.location.search;
                var url;
                if(search.indexOf("?stable")==0){
                    url = "https://github.com/ssatguru/BabylonJS-EditControl/releases/download/v3.0.1/EditControl.min.js";
                }else{
                    url = "dist/EditControl.js";
                }

                var s = document.createElement("script");
                s.src = url;
                document.head.appendChild(s);
                
                //pass on the search parm to next demo
                nextDemo.href = nextDemo.href+search;

                s.onload = main;
            }
        </script>


    </head>

    <body>
        <canvas id="renderCanvas"></canvas>
        <div id="controls">
            <table>
                <tr>
                    <td>
                        Parenting Demo<br>
                        box1 is parent of box2 and box2 is parent of box3
                    </td>
                </tr>
                <tr>
                    <td>
                        select
                        <input type="radio" id="selectBox1" onclick="switchBox();" checked title="select box1" name="sb">box1
                        <input type="radio" id="selectBox2" onclick="switchBox();"         title="select box2" name="sb">box2
                        <input type="radio" id="selectBox3" onclick="switchBox();"         title="select box3" name="sb">box3

                    </td>
                </tr>
                <tr>
                    <td>
                        <button id="hide">hide/show</button>
                        <button id="focus">focus</button>
                    </td>
                </tr>
                <tr>
                    <td>
                        <input type="radio" id="local"  onclick="switchSpace();" name="lg" checked title="switch to local axes">local
                        <input type="radio" id="global" onclick="switchSpace();" name="lg"        title="switch to global axes">global
                    </td>
                </tr>
                <tr>
                    <td>
                        <table>
                            <tr>
                                <td><button id="trans">translate</button></td>
                                <td><button id="rotate">rotate</button></td>
                                <td><button id="scale">scale</button></td>
                            </tr>
                            <tr>
                                <td><input type="checkbox" id="snaptrans">snap translation</td>
                                <td><input type="checkbox" id="snaprot">snap rotation</td>
                                <td><input type="checkbox" id="snapscale">snap scale</td>
                            </tr>
                            <tr>
                                <td><input type="checkbox" id="boundTrans">bound translation</td>
                                <td><input type="checkbox" id="boundRot">bound rotation</td>
                                <td><input type="checkbox" id="boundScale">bound scale</td>
                            </tr>
                            <tr>
                                <td></td>
                                <td><input type="checkbox" id="rotGuideFull">full rotation guides</td>
                                <td></td>
                            </tr>
                            <tr>
                                <td></td>
                                <td>
                                    <button id="euler">toggle euler</button>
                                    <br>
                                    <button id="pRot">print rotation to console</button>
                                </td>
                                <td></td>
                            </tr>
                        </table>
                    </td>
                </tr>
                <tr>
                    <td>
                        <button id="undo">undo</button>
                        <button id="redo">redo</button>
                    </td>
                </tr>
                <tr>
                    <td><button id="help" onclick="showHelp();">help</button></td>
                </tr>
                <tr>
                    <td>
                        next <a id="nextDemo" href="demo.html">Simple Demo</a>
                    </td>
                </tr>
            </table>
        </div>


        <script type="text/javascript">
            var switchBox,showHelp,switchSpace;
            function main(){

                var box;
                var box1;
                var box2;
                var box3;
                var camera;
                var editControl;
                var ec1;
                var ec2;
                var ec3;

                /*
                 * get all buttons
                 */

                var hideButton = document.getElementById("hide");

                var transButton = document.getElementById("trans");
                var rotButton = document.getElementById("rotate");
                var scaleButton = document.getElementById("scale");

                var snapTButton = document.getElementById("snaptrans");
                var snapRButton = document.getElementById("snaprot");
                var snapSButton = document.getElementById("snapscale");

                snapTButton.checked = false;
                snapRButton.checked = false;
                snapSButton.checked = false;

                var boundTButton = document.getElementById("boundTrans");
                var boundRButton = document.getElementById("boundRot");
                var boundSButton = document.getElementById("boundScale");

                boundTButton.checked = false;
                boundRButton.checked = false;
                boundSButton.checked = false;

                var rotGuideFull = document.getElementById("rotGuideFull");
                rotGuideFull.checked = false;

                var undoButton = document.getElementById("undo");
                var redoButton = document.getElementById("redo");

                var focusButton = document.getElementById("focus");

                var pRotButton = document.getElementById("pRot");
                var eulerButton = document.getElementById("euler");


                showHelp = function(){
                    var el = document.getElementById("overlay");
                    el.style.visibility = (el.style.visibility=="visible")?"hidden"
                            :"visible";
                }


                switchBox = function(){
                    if(selectBox1.checked){
                        editControl = ec1;
                        box = box1;
                    }else if(selectBox2.checked){
                        editControl = ec2;
                        box = box2;
                    }else{
                        editControl = ec3;
                        box = box3;
                    }
                    //editControl.switchTo(box);
                    switchSpace();
                    snapTButton.onclick();
                    snapRButton.onclick();
                    snapSButton.onclick();
                    boundTButton.onclick();
                    boundSButton.onclick();
                    rotGuideFull.onclick();
                }

                hideButton.onclick = function(){
                    if(editControl.isHidden()){
                        editControl.show();
                    }else
                        editControl.hide();
                };
                transButton.onclick = function(){
                    editControl.enableTranslation();
                };
                rotButton.onclick = function(){
                    editControl.enableRotation();
                };
                scaleButton.onclick = function(){
                    editControl.enableScaling()
                    if(!editControl.isLocal()){
                        alert("Please note that you cannot scale in global mode");
                    }
                };
                switchSpace = function(){
                    editControl.setLocal(local.checked);
                    if(editControl.isScalingEnabled()&&!editControl.isLocal()){
                        alert("Please note that you cannot scale in global mode");
                    }
                };
                snapTButton.onclick = function(){
                    editControl.setTransSnap(snapTButton.checked);
                };
                snapRButton.onclick = function(){
                    editControl.setRotSnap(snapRButton.checked);
                };
                snapSButton.onclick = function(){
                    editControl.setScaleSnap(snapSButton.checked);
                };

                boundTButton.onclick = function(){
                    if(boundTButton.checked){
                        editControl.setTransBounds(
                                new BABYLON.Vector3(-5,-5,-5),// min
                                new BABYLON.Vector3(5,5,5)      // max
                                );
                    }else{
                        editControl.removeTransBounds();
                    }
                };

                boundRButton.onclick = function(){
                    alert("Rotation Bounds has not been implemented yet");
                }

                boundSButton.onclick = function(){
                    if(boundSButton.checked){
                        editControl.setScaleBounds(
                                // new BABYLON.Vector3(0.00000001,0.00000001,0.00000001),     // works
                                new BABYLON.Vector3(0,0,0),// causes bug
                                new BABYLON.Vector3(2,2,2)      // max
                                );
                    }else{
                        editControl.removeScaleBounds();
                    }
                };

                rotGuideFull.onclick = function(){
                    editControl.setRotGuideFull(rotGuideFull.checked);
                }

                undoButton.onclick = function(){
                    editControl.undo();
                };
                redoButton.onclick = function(){
                    editControl.redo();
                };
                focusButton.onclick = function(){
                    camera.target.copyFrom(box.position);
                };
                pRotButton.onclick = function(){
                    console.log(box.rotation);
                    console.log(box.rotationQuaternion);
                };
                var euler = false;
                eulerButton.onclick = function(){
                    euler = !euler;
                    editControl.returnEuler(euler);
                    console.log("enable euler : "+euler);
                };

                var actionStartListener = function(actionType){
                    if(actionType===0){
                        console.log("translation started");
                    }else if(actionType===1){
                        console.log("rotation started");
                    }else if(actionType===2){
                        console.log("scaling started");
                    }
                }
                var actionListener = function(actionType){
                    if(actionType===0){
                        console.log("translating");
                    }else if(actionType===1){
                        //console.log("rotating");
                    }else if(actionType===2){
                        console.log("scaling");
                    }
                }
                var actionEndListener = function(actionType){
                    if(actionType===0){
                        console.log("translation done");
                    }else if(actionType===1){
                        console.log("rotation done");
                    }else if(actionType===2){
                        console.log("scaling done");
                    }
                }
                var EditControl = org.ssatguru.babylonjs.component.EditControl;
                function attachEditControl(mesh){
                    var ec = new EditControl(mesh,camera,canvas,0.5,false);
                    ec.enableTranslation();
                    ec.setRotSnapValue(3.14/18);
                    ec.setTransSnapValue(0.5);
                    ec.setScaleSnapValue(0.25);
                    ec.addActionStartListener(actionStartListener);
                    ec.addActionListener(actionListener);
                    ec.addActionEndListener(actionEndListener);
                    return ec;
                }

                /*
                 * The scene
                 */
                var canvas = document.querySelector("#renderCanvas");

                var engine = new BABYLON.Engine(canvas,true);

                var createScene = function(){

                    var scene = new BABYLON.Scene(engine);

                    scene.clearColor = new BABYLON.Color3(0.75,0.75,0.75);
                    //scene.useRightHandedSystem = true;

                    camera = new BABYLON.ArcRotateCamera("ArcRotateCamera",Math.PI/4,Math.PI/4,
                            20,new BABYLON.Vector3(0,0,0),scene);
                    camera.wheelPrecision = 15;
                    camera.setTarget(BABYLON.Vector3.Zero());
                    camera.attachControl(canvas,false);

                    var light = new BABYLON.HemisphericLight("light1",
                            new BABYLON.Vector3(0,1,0),scene);
                    light.intensity = .5;
                    
                    var mat = new BABYLON.StandardMaterial("mat", scene);
                    mat.diffuseColor = new BABYLON.Color3(1, 0, 0); 
                    
                    var mat2 = new BABYLON.StandardMaterial("mat2", scene);
                    mat2.diffuseColor = new BABYLON.Color3.Teal();
                    
                    var mat3 = new BABYLON.StandardMaterial("mat3", scene);
                    mat3.diffuseColor = new BABYLON.Color3.Magenta();

                    box1 = BABYLON.MeshBuilder.CreateBox("box1",{height:5,width:3,depth:2});
                    box1.rotationQuaternion = BABYLON.Quaternion.Identity();
                    box1.position = new BABYLON.Vector3(0,1,0);
                    box1.material=mat;

                    box2 = BABYLON.MeshBuilder.CreateBox("box2",{height:3,width:2,depth:1});
                    box2.rotationQuaternion = BABYLON.Quaternion.Identity();
                    box2.position = new BABYLON.Vector3(-4,0,0);
                    box2.material=mat2;
                    box2.parent = box1;

                    box3 = BABYLON.MeshBuilder.CreateBox("box3",{height:2,width:1,depth:2});
                    box3.rotationQuaternion = BABYLON.Quaternion.Identity();
                    box3.position = new BABYLON.Vector3(-4,0,0);
                    box3.material=mat3;
                    box3.parent = box2;

                    ec1 = attachEditControl(box1);
                    ec2 = attachEditControl(box2);
                    ec3 = attachEditControl(box3);

                    box = box1;
                    editControl = ec1;

                    var ground = BABYLON.Mesh.CreateGround("ground1",20,20,10,scene);
                    var gridMaterial = new BABYLON.StandardMaterial("Grid Material",scene);
                    gridMaterial.wireframe = true;
                    ground.material = gridMaterial;

                    return scene;
                };

                var scene = createScene();

                engine.runRenderLoop(function(){
                    scene.render();
                });
                window.addEventListener("resize",function(){
                    engine.resize();
                });
            }
        </script>

        <div id="overlay">
            <div>
                <h2>Demo of EditControl for Babylonjs</h2>
                <p>
                    For more information and source code head on over to <br>
                    <a href="https://github.com/ssatguru/Babylonjs-EditControl"
                       target='link'>
                        https://github.com/ssatguru/Babylonjs-EditControl</a>
                </p>
                <button id="closehelp" onclick="showHelp();">close</button>
            </div>
        </div>

    </body>
</html>
